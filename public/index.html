<!DOCTYPE html>
<html>
  <head>
    <title>vermillion</title>
    <link rel="icon" href="favicon.ico">
    <meta name="google-signin-client_id" content="424801076-k3qob600q4v0ccpuj3a7807o99mianc0.apps.googleusercontent.com">
    <meta charset="UTF-8">
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      function addDarkmodeWidget() {
        const options = {
          bottom: '94vh', // default: '32px'
          right: 'unset', // default: '32px'
          left: '48.5vw', // default: 'unset'
          time: '.75s', // default: '0.3s'
          mixColor: '#fff', // default: '#fff'
          backgroundColor: '#fff',  // default: '#fff'
          buttonColorDark: '#100f2c',  // default: '#100f2c'
          buttonColorLight: '#fff', // default: '#fff'
          saveInCookies: true, // default: true,
          label: '', // default: ''
          autoMatchOsTheme: true // default: true
        }

        const darkmode = new Darkmode(options);
        darkmode.showWidget();
      }
      window.addEventListener('load', addDarkmodeWidget);

      function onSignIn(googleUser) {
        let profile = googleUser.getBasicProfile();
        sessionStorage.setItem("name", profile.getName())

        var pfp_text = document.createElement("p");
        var text = document.createTextNode(profile.getName());

        var pfp = document.createElement("img");
        pfp.id = "pfp";

        pfp_text.style = "position: fixed; top: 1.5vh; left: 5vw"
        pfp_text.appendChild(text);
        pfp.style = "position: fixed; top: 1vh; left: 1vw; width: 60.5px; height: auto"

        var element = document.getElementById("top");

        element.appendChild(pfp_text);
        element.appendChild(pfp);

        document.getElementById("pfp").src = profile.getImageUrl()
        document.getElementById("pfp").onclick = dark;
      }
    </script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300&display=swap');

      * {
        overflow-x: hidden;
        font-family: 'Roboto Mono';
      }

      body {
        margin: 0;
        padding-bottom: 3rem;
      }
      
      #form {
        padding: 0.25rem;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        height: 3rem;
        box-sizing: border-box;
      }

      #form > button {
        background: white;
        border: none;
        padding: 0 1rem;
        margin: 0.25rem;
        border-radius: 3px;
        outline: none;
        color: #fff;
        display: none;
      }

      input { 
        border-left: none; 
        border-right: none; 
        border-top: none; 
        border-bottom: solid black 1.5px; 
        width: 100vw; 
        height: 3vh; 
        font-size:20px;
        text-align: center;
        bottom: -0.75vh;
        position: relative;
        background: transparent;
      }

      input:focus {
        outline: none;
      }

      #messages {
        list-style-type: none;
        padding: 0;
        position: relative;
        top: 6.5vh;
      }
      
      #messages > li {
        padding: 1rem 1rem;
        z-index: -1;
      }

      li:hover {
        background-color: rgb(245, 245, 245);
      }

      a {
        color: black;
        text-decoration: underline;
      }

      a:hover {
        color: rgb(129, 129, 129);
      }

      a:focus {
        outline: none;
      }

      h1 {
        text-align: center;
      }

      ::placeholder {
        text-align: center;
        opacity: 100%;
      }
      
      .darkmode--activated li {
        color: white;
      }.darkmode--activated li:hover {
        background-color:rgb(24, 24, 24);
      }.darkmode--activated ::placeholder {
        color: white;
      }.darkmode--activated #form > input {
        color: white;
        border-bottom: solid white 1px;
      }.darkmode--activated p {
        color: white;
      }.darkmode--activated h1 {
        color: black;
      }.darkmode--activated a {
        color: white;
      }.darkmode--activated a:hover {
        color: rgb(129, 129, 129);
      }

      .darkmode-toggle {
        z-index: 500;
      }

      #signin {
       position: fixed;
       top: 2.5vh;
       right: 2vw;
       z-index: 1;
      }

      @media only screen and (max-width: 500px) {
        body {
          background: transparent;
        }

        #form {
          width: 100vw;
          height: 1vh;
          z-index: 10;
        }

        input[type="color"],
        input[type="date"],
        input[type="datetime"],
        input[type="datetime-local"],
        input[type="email"],
        input[type="month"],
        input[type="number"],
        input[type="password"],
        input[type="search"],
        input[type="tel"],
        input[type="text"],
        input[type="time"],
        input[type="url"],
        input[type="week"],
        select:focus,
        textarea {
          font-size: 16px;
        }

        input {
          font-size: 20px;
        }

        #form > button {
          display: block;
          position: absolute;
          bottom: 2vh;
          width: 100vw;
          height: 10vh;
        }
        
        input {
          width: 100vw;
          bottom: 3vh;
          z-index: 10;
        }

        ::placeholder {
          text-align: left;
        }
      }
    </style>
  </head>
  <body id="body">
    <ul scroll="no" id="messages"></ul>

    <!-- If no messages are sent, display a message to show nothing is wrong -->

    <h1 id='no1'><br><br><br><br><br>¬Ø\('-')/¬Ø</h1>
    <h1 id='no2'>nobody's sent any messages yet. <br>you can log in while you wait.</h1>

    <form id="form" action="">

      <!-- Message input -->

      <input id="input" placeholder='Message everyone in this room' autocomplete="off" autofocus/><button></button>
    </form>

    <!-- Google sign in -->

    <div id="top">
      <div class="g-signin2" id="signin" data-onsuccess="onSignIn"></div>
    </div>
    <!-- Import socket.io script -->
  </body>
  <script>
      // Import socket.io

      var socket = io();

      // Help message

      var help = 
      `
      asked for help.

      <br>
      <br>

      /help - displays this message.
      <br>
      /i [link to an image] - displays an image.
      <br>
      /a [link] - displays a clickable hyperlink. (Automatic links are still used, but certain protocols won't be detected)
      <br>
      <br>
      Planned commands:
      <br>
      /v [link to video] - embed a YouTube video.
      <br>
      [drag and drop file] - embed a downloadable file.
      <br>
      /f [method] - format your message in a number of ways.

      Click the circle at the top to switch themes.
      `

      // Get values

      var messages = document.getElementById('messages');
      var form = document.getElementById('form');
      var input = document.getElementById('input');

      // Basic messaging
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (input.value) {
          // If they are signed in with Google

          if (sessionStorage.getItem("name") !== undefined && sessionStorage.getItem("name") !== null) {
            d = new Date()
            socket.emit('chat message', sessionStorage.getItem("name") + ' ê§ü ' + input.value);
            var time = document.createElement('li');
            time.innerHTML = d.getHours() + ':' + d.getMinutes();
            time.style = 'position: absolute; right: 2vw';
            messages.appendChild(time);
          }
          // If they aren't signed in

          else {
            d = new Date()
            socket.emit('chat message', 'User ê§ü ' + input.value);
            var time = document.createElement('li');
            time.innerHTML = d.getHours() + ':' + d.getMinutes()
            time.style = 'position: absolute; right: 2vw';
            messages.appendChild(time);
          }
          input.value = ''
        }
      });

      socket.on('chat message', function(msg) {
        // Commands
        // temp is used when msg is needed for its data

        if (msg.split('ê§ü')[1].substring(1, 2) == '/') {
          // Images ( /i [link to image] )

          if (msg.split('ê§ü')[1].substring(2, 3) == 'i' && msg.split('ê§ü')[1].substring(3, 4) == ' ') {
            if (sessionStorage.getItem("name") !== undefined && sessionStorage.getItem("name") !== null) { 
              temp = sessionStorage.getItem("name")+' ê§ü '+'<img width=\"200\" height=\"auto\" src=\"'+msg.split('ê§ü')[1].substring(4, msg.length)+'\">'
              msg = temp
            }else {
              temp = 'User ê§ü '+'<img width=\"350\" height=\"auto\" src=\"'+msg.split('ê§ü')[1].substring(4, msg.length)+'\">'
              msg = temp
            }
          }
          
          // Help ( /help )

          else if ((msg.split('ê§ü')[1].substring(2, 3) == 'h' && msg.length < 3) || msg.split('ê§ü')[1].substring(2, 6) == 'help') {
            if (sessionStorage.getItem("name") !== undefined && sessionStorage.getItem("name") !== null) {
              msg = sessionStorage.getItem("name")+help
            }
            else {
              `User ` + help
            }
          }

          // Links ( /a [link] )

          else if (msg.split('ê§ü')[1].substring(2, 3) == 'a' && msg.split('ê§ü')[1].substring(3, 4) == ' ') {
           if (sessionStorage.getItem("name") !== undefined && sessionStorage.getItem("name") !== null) {
             temp = sessionStorage.getItem("name") + ' ê§ü ' + '<a href=\"'+msg.split('ê§ü')[1].substring(4, msg.length)+'\" target=\"_blank\" >Link to '+msg.split('ê§ü')[1].substring(4, msg.length)+'</a>'
           }
           else {
            'User ê§ü ' + '<a href=\"'+msg.split('ê§ü')[1].substring(4, msg.length)+'\" target=\"_blank\" >Link to '+msg.split('ê§ü')[1].substring(4, msg.length)+'</a>'
           }
           msg = temp
          }
          
          // If they use a command not implemented

          else {
            if (sessionStorage.getItem("name") !== undefined && sessionStorage.getItem("name") !== null) { 
              msg = sessionStorage.getItem("name") + ' tried to use an unrecognised command.'
            }else {
              msg = 'User tried to use an unrecognised command.'
            }
          }
          
        // Dynamic links

        }else if (msg.split('ê§ü')[1].substring(1, 8) == 'http://' || msg.split('ê§ü')[1].substring(1, 9) == 'https://' || msg.split('ê§ü')[1].substring(1, 7) == 'ftp://') {
          if (sessionStorage.getItem("name") !== undefined && sessionStorage.getItem("name") !== null) {
            temp = sessionStorage.getItem("name") + ' ê§ü ' + '<a href=\"'+msg.split('ê§ü')[1]+'\" target=\"_blank\" >Link to '+msg.split('ê§ü')[1]+'</a>'
          }else {
            temp = 'User ê§ü ' + '<a href=\"'+msg.split('ê§ü')[1]+'\">Link to '+msg.split('ê§ü')[1]+'</a>'
          }
          msg = temp
        }

        // Item is the actual message

        var item = document.createElement('li');

        item.innerHTML = msg;
        messages.appendChild(item);

        // Scrolls to the bottom of the document when a lot of messages are sent

        window.scrollTo(0, document.body.scrollHeight);

        // Removes " no messages " h1

        if (document.getElementById('no1').innerHTML) {
          document.getElementById('no1').remove();
          document.getElementById('no2').remove();
        }
      });
  </script>
</html>