<!DOCTYPE html>
<html>
  <head>
    <title>vermillion</title>
    <link rel="icon" href="favicon.ico">
    <meta name="google-signin-client_id" content="424801076-k3qob600q4v0ccpuj3a7807o99mianc0.apps.googleusercontent.com">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="app.js"></script>
    <link rel="stylesheet" href="style.css">
  </head>
  <body id="body">
    <ul scroll="no" id="messages"></ul>

    <!-- If no messages are sent, display a message to show nothing is wrong -->

    <h1 id='no1'><br><br><br><br><br>¯ \ ( ' - ' ) / ¯</h1>
    <h1 id='no2'>nobody's sent any messages yet. <br>you can log in while you wait.</h1>

    <form id="form" action="">
      <!-- Message input -->

      <input id="input" placeholder='Message everyone in this room' autocomplete="off" autofocus/><button></button>
    </form>

    <!-- Google sign in -->
    <div class="header" id="header">
        <div class="g-signin2" id="signin" data-onsuccess="onSignIn">button</div>
    </div>
    
  </body>
  <script>
  // Import socket.io

  var socket = io();

  // Headers

  var headers = new Headers();

  headers.append('Bypass-Tunnel-Reminder', 'asdasd');

  // Help message

  var help = 
  `
  asked for help.

  <br>
  <br>

  /help - displays this message.
  <br>
  /i [link to an image] - displays an image.
  <br>
  /a [link] - displays a clickable hyperlink. (Automatic links are still used, but certain protocols won't be detected)
  <br>
  <br>
  Planned commands:
  <br>
  /v [link to video] - embed a YouTube video.
  <br>
  [drag and drop file] - embed a downloadable file.
  <br>
  /f [method] - format your message in a number of ways.

  Click the circle at the top to switch themes.
  `

  // Get values

  var messages = document.getElementById('messages');
  var form = document.getElementById('form');
  var input = document.getElementById('input');

  // Basic messaging
  form.addEventListener('submit', function(e) {
      e.preventDefault();
      if (input.value) {
          // If they are signed in with Google

          if (sessionStorage.getItem("name") !== null) {
              d = new Date()
              socket.emit('chat message', sessionStorage.getItem("name") + ' 𐤟 ' + input.value);

              var time = document.createElement('li');
              time.innerHTML = d.getHours() + ':' + d.getMinutes();
              time.style = 'position: absolute; right: 2vw; z-index: 500';
              messages.appendChild(time);
          }
          // If they aren't signed in

          else {
              d = new Date()
              socket.emit('chat message', 'User 𐤟 ' + input.value);
              var time = document.createElement('li');
              time.innerHTML = d.getHours() + ':' + d.getMinutes()
              time.style = 'position: absolute; right: 2vw';
              messages.appendChild(time);
          }

          input.value = ""
      }
  });

  socket.on('chat message', function(msg) {
    // Commands
    // temp is used when msg is needed for its data

    if (msg.split('𐤟')[1].substring(1, 2) == '/') {
        // Images ( /i [link to image] )

        if (msg.split('𐤟')[1].substring(2, 3) == 'i' && msg.split('𐤟')[1].substring(3, 4) == ' ') {
            if (sessionStorage.getItem("name") !== null) { 
                temp = sessionStorage.getItem("name")+' 𐤟 '+'<img width=\"200\" height=\"auto\" src=\"'+msg.split('𐤟')[1].substring(4, msg.length)+'\">'
                msg = temp
            }else {
                temp = 'User 𐤟 '+'<img width=\"350\" height=\"auto\" src=\"'+msg.split('𐤟')[1].substring(4, msg.length)+'\">'
                msg = temp
            }
            }
            
            // Help ( /help )

            else if ((msg.split('𐤟')[1].substring(2, 3) == 'h' && msg.length < 3) || msg.split('𐤟')[1].substring(2, 6) == 'help') {
            if (sessionStorage.getItem("name") !== null) {
                msg = sessionStorage.getItem("name")+help
            }
            else {
                `User ` + help
            }
            }

            // Links ( /a [link] )

            else if (msg.split('𐤟')[1].substring(2, 3) == 'a' && msg.split('𐤟')[1].substring(3, 4) == ' ') {
            if (sessionStorage.getItem("name") !== null) {
              temp = sessionStorage.getItem("name") + ' 𐤟 ' + '<a href=\"'+msg.split('𐤟')[1].substring(4, msg.length)+'\" target=\"_blank\" >Link to '+msg.split('𐤟')[1].substring(4, msg.length)+'</a>'
            }
            else {
              'User 𐤟 ' + '<a href=\"'+msg.split('𐤟')[1].substring(4, msg.length)+'\" target=\"_blank\" >Link to '+msg.split('𐤟')[1].substring(4, msg.length)+'</a>'
            }
            msg = temp
            }
            
            // If they use a command not implemented

            else {
            if (sessionStorage.getItem("name") !== null) { 
              msg = sessionStorage.getItem("name") + ' tried to use an unrecognised command.'
            }else {
              msg = 'User tried to use an unrecognised command.'
            }
        }
        
    // Dynamic links and images

    }else if (msg.split('𐤟')[1].substring(1, 8) == 'http://' || msg.split('𐤟')[1].substring(1, 9) == 'https://' || msg.split('𐤟')[1].substring(1, 7) == 'ftp://') {
      if (/(jpg|gif|png)$/.test(msg.split('𐤟')[1]) == true) {
        alert('imag!')
      }
      if (sessionStorage.getItem("name") !== null) {
          temp = sessionStorage.getItem("name") + ' 𐤟 ' + '<a href=\"'+msg.split('𐤟')[1]+'\" target=\"_blank\" >Link to '+msg.split('𐤟')[1]+'</a>'
      }else {
          temp = 'User 𐤟 ' + '<a href=\"'+msg.split('𐤟')[1]+'\">Link to '+msg.split('𐤟')[1]+'</a>'
      }
      msg = temp
    }

    // Item is the actual message

    var item = document.createElement('li');

    item.innerHTML = msg;
    messages.appendChild(item);

    // Scrolls to the bottom of the document when a lot of messages are sent

    window.scrollTo(0, document.body.scrollHeight);

    // Removes " no messages " h1

    if (document.getElementById('no1').innerHTML) {
        document.getElementById('no1').remove();
        document.getElementById('no2').remove();
    }
  });
  </script>
</html>